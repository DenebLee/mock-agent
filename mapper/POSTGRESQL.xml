<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="nanoit.kr.repository.MessageRepository">

    <!--   default setting   -->
    <update id="createTable">
        CREATE TABLE "agent_table" (
        "id" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
        "selected" varchar(16),
        "phone_number" varchar(32) NOT NULL,
        "send_result" varchar(32) NOT NULL,
        "callback_number" varchar(32) NOT NULL,
        "sender_name" varchar(64) NOT NULL,
        "content" varchar(255) NOT NULL,
        "send_time" timestamptz NOT NULL,
        "receive_result" varchar(32) NOT NULL,
        "receive_time" timestamptz NOT NULL,
        "created_at" timestamptz NOT NULL,
        "last_modified_at" timestamptz NOT NULL
        );
    </update>

    <update id="createMessageResultTable">
        CREATE TABLE "message_result" (
        "result" varchar(32) UNIQUE NOT NULL
        );
    </update>

    <update id="foreignKeySet">
        ALTER TABLE "send" ADD FOREIGN KEY ("receive_result",send_result) REFERENCES "message_result" ("result");
    </update>

    <insert id="receive_insertResult">
        INSERT INTO "receive_message_result" (result)
        VALUES ('SUCCESS'),
               ('FAILED')
        ON CONFLICT (result)
            DO NOTHING;
    </insert>

    <!--   default setting end -->

    <!-- common Query -->
    <delete id="deleteTable">
        DELETE FROM agent_table;
    </delete>

    <select id="ping" resultType="java.lang.Boolean">
        SELECT 1;
    </select>

    <delete id="deleteById" parameterType="_long">
        DELETE FROM agent_table WHERE id = #{id};
    </delete>

    <select id="count" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM agent_table;
    </select>

    <!-- Query settings for receive tables -->

    <select id="receive_count" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM agent_table WHERE receive_result = 'SUCCESS' AND receive_time IS NOT NULL;
    </select>

    <select id="receive_selectById" parameterType="_long" resultType="nanoit.kr.domain.entity.SendAckEntity">
        SELECT id,receive_result FROM agent_table WHERE id = #{id];
    </select>
    
    <select id="receive_selectAll" resultType="nanoit.kr.domain.entity.SendAckEntity">
        SELECT id, receive_result FROM agent_table;
    </select>
</mapper>

